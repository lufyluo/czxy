<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.czxy.manage.dao.ClassMapper">
    <sql id="base_column">
               id
        ,name
        ,province_id as provinceId
        ,city_id as cityId
        ,county_id as countyId
        ,org_id as orgId
        ,begin_time as beginTime
        ,end_time as endTime
        ,arrange_id as arrangeId
        updated_time as updatedTime, created_time as createdTime
    </sql>
    <insert id="insert" useGeneratedKeys="true"
            keyProperty="id">
        insert into class(
        name,province_id,city_id,county_id,org_id,arrange_id,recommend_org_id,composition_id,
        begin_time,end_time,duration,addr
        )values(
        #{name},#{provinceId},#{cityId},#{countyId},#{orgId},#{arrangeId},#{recommendOrgId},#{compositionId},
        #{beginTime},#{endTime},#{duration},#{addr}
        )
    </insert>
    <update id="update">
        update class
        set
        name = #{name}
        ,province_id = #{provinceId}
        ,city_id = #{cityId}
        ,county_id = #{countyId}
        ,org_id = #{orgId}
        ,begin_time = #{beginTime}
        ,end_time = #{endTime}
        ,arrange_id = #{arrangeId}
        ,recommend_org_id = #{recommendOrgId}
        ,duration = #{duration}
        ,composition_id = #{compositionId}
        ,updated_time = now()
        where id =#{id}
    </update>
    <delete id="delete">
        delete from class where id in <foreach collection="id" item="item" index="index"
                                               open="(" separator="," close=")">#{item}
                                      </foreach>
    </delete>

    <select id="queryAll" resultType="com.czxy.manage.model.entity.ClassOrgEntity">
        select
         c.id
        ,c.name
        ,c.province_id as provinceId
        ,c.city_id as cityId
        ,c.county_id as countyId
        ,c.org_id as orgId
        ,c.begin_time as beginTime
        ,c.end_time as endTime
        ,c.arrange_id as arrangeId
        ,c.composition_id as compositionId
        ,c.addr
        ,c.updated_time as updatedTime, c.created_time as createdTime
        ,o.name as orgName
        ,u.name as masterName
        ,u1.name as leaderName
        ,s.id  as leaderId
        from class c
        left join org o
        on c.org_id = o.id
        left join class_master cm
        on c.id = cm.class_id and cm.type = 0
        left join user u
        on cm.user_id = u.id
        left join student s
        on s.class_id = c.id and s.type = 8
        left join user u1
        on s.user_id = u1.id
        <if test="param != null and param != ''">
            where name like '%${param}%' or org_name like '%${param}%' or u.name like '%${param}%'
        </if>
        order by name,orgName,masterName
    </select>
    <select id="query" resultType="com.czxy.manage.model.entity.ClassInformationEntity">
        select
        c.id,
        c.name,
        c.province_id as provinceId,
        c.city_id as cityId,
        c.county_id as countyId,
        c.org_id as orgId,
        c.begin_time as beginTime,
        c.end_time as endTime,
        c.arrange_id as arrangeId,
        c.recommend_org_id as recommendOrgId,
        c.composition_id as compositionId,
        c.updated_time as updatedTime,
        c.created_time as createdTime,
        c.appellation,
        c.duration as duration,
        o.name as orgName,
        a.path as addressName,
        u.name as masterName,
        ul.name as leaderName,
        og.name as recommendOrgName
        from class c
        left join org o
        on c.org_id = o.id
        left join address a
        on c.county_id = a.id
        left join class_master cm
        on c.id = cm.class_id
        left join user u
        on cm.user_id = u.id
        left join student s
        on  s.class_id = c.id and s.type = 8
        left join user ul
        on ul.id = s.user_id
        left join org og
        on c.recommend_org_id = og.id
        where c.id = #{id}
    </select>
    <select id="queryAllStudent" resultType="com.czxy.manage.model.entity.ClassStudentEntity">
        select
        u.id as userId,
        u.name as userName,
        u.idcard as userIdCard,
        u.phone as userPhone,
        u.gender as userGender,
        u.position as userPosition,
        u.age as userAge,
        u.birthday as userBirthday,
        u.category as userCategory,
        u.wechat_id as userWechatId,
        u.updated_time as updatedTime,
        u.created_time as createdTime,
        u.org_id as userOrgId,
        u.nation as userNation,
        u.nativeplace as userNativeplace,
        s.type as StudentType,
        s.id as studentId
        from user u
        left join student s
        on s.user_id = u.id
        where s.class_id = #{classId}
        order by s.id desc
    </select>
</mapper>